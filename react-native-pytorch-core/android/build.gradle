/*
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

import groovy.json.JsonSlurper
import org.apache.tools.ant.filters.ReplaceTokens

// read the React-Native version of local app
def parseAppRnVersion() {
   def inputFile = new File(rootDir, '../node_modules/react-native/package.json')
   def json = new JsonSlurper().parseText(inputFile.text)
   return json.version as String
}

def (appRnMajorVersion, appRnMinorVersion, appRnPatchVersion) = parseAppRnVersion().tokenize('.')

buildscript {
  if (project == rootProject) {
    repositories {
      google()
      jcenter()
      maven {
        url "https://plugins.gradle.org/m2/"
      }
    }
    dependencies {
      classpath "com.android.tools.build:gradle:3.5.3"
    }
  }
}

apply plugin: "com.android.library"

def safeExtGet(prop, fallback) {
    rootProject.ext.has(prop) ? rootProject.ext.get(prop) : fallback
}

android {
  compileSdkVersion safeExtGet('PyTorchCore_compileSdkVersion', 31)
  buildToolsVersion safeExtGet('PyTorchCore_buildToolsVersion', '30.0.2')
  defaultConfig {
    minSdkVersion safeExtGet('PyTorchCore_minSdkVersion', 21)
    targetSdkVersion safeExtGet('PyTorchCore_targetSdkVersion', 30)
    versionCode 1
    versionName "1.0"
    testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    packagingOptions {
      pickFirst '**/*.so'
    }
    externalNativeBuild {
      cmake {
        cppFlags "-fexceptions", "-frtti", "-std=c++1y", "-DONANDROID"
        abiFilters 'x86', 'x86_64', 'armeabi-v7a', 'arm64-v8a'
        arguments '-DANDROID_STL=c++_shared', "-DNODE_MODULES_DIR=${rootDir}/../node_modules", "-DREACT_NATIVE_MINOR_VERSION=${appRnMinorVersion}"
      }
    }
  }

  buildTypes {
    release {
      minifyEnabled false
    }
  }
  lintOptions {
   disable 'GradleCompatible'
  }
  compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
  }
  externalNativeBuild {
    cmake {
      path "CMakeLists.txt"
    }
  }

  // Exclude META-INF/MANIFEST.MF otherwise the Detox build will fail with
  // message "More than one file was found with OS independent path 'META-INF/MANIFEST.MF'."
  // A potential solution would be upgrading the Gradle version as mentioned
  // in the following Stack Overflow comment:
  // https://stackoverflow.com/questions/58745742/error-duplicate-entry-meta-inf-manifest-mf
  packagingOptions {
    excludes = ["**/libc++_shared.so","**/libreactnativeutilsjni.so",'META-INF/MANIFEST.MF']
  }

  configurations {
    extractHeaders
    extractJNI
    extractForNativeBuild
  }
}

repositories {
    mavenCentral()
    mavenLocal()
    maven {
        // All of React Native (JS, Obj-C sources, Android binaries) is installed from npm
        url("$rootDir/../node_modules/react-native/android")
    }
    google()
    jcenter()

  // Repository holding the PyTorch Mobile libraries for Android
  maven {
    url "https://oss.sonatype.org/content/repositories/snapshots"
  }
}

dependencies {
  def pytorchLiteVersion = '1.12.2'
  implementation "org.pytorch:pytorch_android_lite:${pytorchLiteVersion}"
  implementation "org.pytorch:pytorch_android_torchvision_lite:${pytorchLiteVersion}"

  //noinspection GradleDynamicVersion
  api "com.facebook.react:react-native:+"  // From node_modules

  //noinspection GradleDynamicVersion
  extractHeaders("com.facebook.fbjni:fbjni:+:headers")
  //noinspection GradleDynamicVersion
  extractJNI("com.facebook.fbjni:fbjni:+")

  def nodeModules = "${rootDir}/../node_modules"

  // For now we use the release version of the jni library
  // we will look back on this once we figure out how to
  // get the buildType duing configuration stage
  def buildType = "release"

  if(Integer.parseInt(appRnMinorVersion)  < 69) {
      def rnAAR = fileTree("${nodeModules}/react-native/android").matching({ it.include "**/**/*.aar" }).singleFile
      extractJNI(files(rnAAR))
  } else {
      // React Native 0.69
      def rnAarMatcher = "**/react-native/**/*${buildType}.aar"
      def rnAAR = fileTree("${nodeModules}/react-native/android").matching({ it.include rnAarMatcher }).singleFile
      extractJNI(files(rnAAR))
  }

  extractForNativeBuild("org.pytorch:pytorch_android_lite:${pytorchLiteVersion}")

  implementation "androidx.appcompat:appcompat:1.2.0"
  implementation "com.android.support.constraint:constraint-layout:2.0.4"
  implementation "androidx.coordinatorlayout:coordinatorlayout:1.1.0"

  implementation "androidx.cardview:cardview:1.0.0"
